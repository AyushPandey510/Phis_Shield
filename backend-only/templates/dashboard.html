{% extends "base.html" %}

{% block title %}PhisGuard Security Dashboard{% endblock %}

{% block content %}
<button class="refresh-btn" onclick="refreshData()">Refresh Data</button>

<div class="dashboard-grid">
    <!-- Analytics Cards -->
    <div class="card">
        <h3>URLs Protected</h3>
        <div class="metric" id="total-checks">-</div>
        <p>Total security checks</p>
    </div>

    <div class="card">
        <h3>Risk Distribution</h3>
        <canvas id="riskChart"></canvas>
    </div>

    <div class="card">
        <h3>Top Suspicious URLs</h3>
        <table id="suspicious-urls-table">
            <thead>
                <tr>
                    <th>URL</th>
                    <th>Risk Score</th>
                    <th>Checks</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="3">Loading...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- Recent Security Events -->
    <div class="card">
        <h3>Security Timeline</h3>
        <table id="events-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Event</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="2">Loading...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- Breach Statistics -->
    <div class="card">
        <h3>Breach Statistics</h3>
        <div class="metric" id="breach-count">-</div>
        <p>Breached accounts in database</p>
        <canvas id="breachChart" class="chart-container"></canvas>
    </div>

    <!-- User Reports -->
    <div class="card">
        <h3>User Reports</h3>
        <div class="metric" id="user-reports">-</div>
        <p>Pending reports</p>
        <table id="reports-table">
            <thead>
                <tr>
                    <th>Report ID</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Submitted</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="4">No reports available</td></tr>
            </tbody>
        </table>
    </div>

    <!-- User Feedback -->
    <div class="card">
        <h3>User Feedback</h3>
        <div class="metric" id="feedback-count">-</div>
        <p>Feedback submissions</p>
        <table id="feedback-table">
            <thead>
                <tr>
                    <th>URL</th>
                    <th>Original Risk</th>
                    <th>User Correction</th>
                    <th>Submitted</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="4">Loading feedback...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- Model Management -->
    <div class="card">
        <h3>Model Management</h3>
        <div class="model-status">
            <div class="model-info">
                <h4>URL Model</h4>
                <p>Current: <span id="url-model-version">-</span></p>
                <p>Status: <span id="url-model-status">-</span></p>
                <select id="url-model-versions">
                    <option>Loading...</option>
                </select>
                <button onclick="switchModel('url')" class="settings-btn">Switch Version</button>
            </div>
            <div class="model-info">
                <h4>Email Model</h4>
                <p>Current: <span id="email-model-version">-</span></p>
                <p>Status: <span id="email-model-status">-</span></p>
                <select id="email-model-versions">
                    <option>Loading...</option>
                </select>
                <button onclick="switchModel('email')" class="settings-btn">Switch Version</button>
            </div>
        </div>
        <div class="model-actions">
            <button onclick="retrainModels()" class="settings-btn" id="retrain-btn">Retrain Models</button>
            <span id="retrain-status"></span>
        </div>
        <div class="training-history">
            <h4>Recent Training Sessions</h4>
            <table id="training-history-table">
                <thead>
                    <tr>
                        <th>Version</th>
                        <th>Timestamp</th>
                        <th>URL Accuracy</th>
                        <th>Email Accuracy</th>
                        <th>Samples</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let riskChart, breachChart;

async function loadDashboardData() {
    try {
        // Use the working user security dashboard endpoint
        const response = await fetch('/user/security-dashboard');
        const data = await response.json();

        // Transform the data to match expected format
        const analytics = {
            total_checks: data.protected_count || 0,
            safe_count: data.low_risk_count || 0,
            caution_count: data.medium_risk_count || 0,
            danger_count: data.high_risk_count || 0,
            top_urls: data.recent_detections?.slice(0, 3).map(detection => ({
                url: detection.url || 'Unknown',
                risk_score: detection.risk_level === 'danger' ? 90 : detection.risk_level === 'caution' ? 50 : 10,
                checks: 1
            })) || []
        };

        const events = {
            recent_events: data.security_timeline || []
        };

        const feedback = {
            feedback_items: data.recent_detections || []
        };

        updateAnalytics(analytics);
        updateEvents(events);
        updateBreaches({ breaches: [] }); // Empty for now
        updateReports({ reports: [] }); // Empty for now
        updateFeedback(feedback);
        updateModelStatus({ status: 'active', accuracy: 0.95 }); // Mock model status
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        // Show error message to user
        document.querySelectorAll('.metric').forEach(el => {
            el.textContent = 'Error loading data';
        });
    }
}

function updateAnalytics(data) {
    document.getElementById('total-checks').textContent = data.total_checks || 0;

    // Update risk distribution chart
    if (riskChart) riskChart.destroy();
    const ctx = document.getElementById('riskChart').getContext('2d');
    riskChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Safe (<30)', 'Caution (30-70)', 'Danger (>70)'],
            datasets: [{
                data: [data.safe_count || 0, data.caution_count || 0, data.danger_count || 0],
                backgroundColor: ['#28a745', '#ffc107', '#dc3545']
            }]
        }
    });

    // Update suspicious URLs table
    const tbody = document.querySelector('#suspicious-urls-table tbody');
    tbody.innerHTML = (data.top_urls || []).map(url =>
        `<tr>
            <td>${url.url}</td>
            <td>${url.risk_score}</td>
            <td>${url.checks}</td>
        </tr>`
    ).join('');
}

function updateEvents(events) {
    const tbody = document.querySelector('#events-table tbody');
    tbody.innerHTML = (events.recent_events || []).slice(0, 10).map(event =>
        `<tr>
            <td>${new Date(event.timestamp).toLocaleString()}</td>
            <td>${event.event}</td>
        </tr>`
    ).join('');
}

function updateBreaches(data) {
    document.getElementById('breach-count').textContent = data.total_breaches || 0;

    if (breachChart) breachChart.destroy();
    const ctx = document.getElementById('breachChart').getContext('2d');
    breachChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Breached', 'Safe'],
            datasets: [{
                label: 'Accounts',
                data: [data.breached_count || 0, data.safe_count || 0],
                backgroundColor: ['#dc3545', '#28a745']
            }]
        }
    });
}

function updateReports(reports) {
    document.getElementById('user-reports').textContent = reports.pending_count || 0;

    const tbody = document.querySelector('#reports-table tbody');
    tbody.innerHTML = (reports.reports || []).map(report =>
        `<tr>
            <td>${report.id}</td>
            <td>${report.type}</td>
            <td>${report.status}</td>
            <td>${new Date(report.submitted).toLocaleString()}</td>
        </tr>`
    ).join('');
}

function updateFeedback(feedback) {
    document.getElementById('feedback-count').textContent = feedback.total_feedback || 0;

    const tbody = document.querySelector('#feedback-table tbody');
    const feedbackItems = (feedback.feedback || []).slice(0, 10); // Show last 10

    if (feedbackItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4">No feedback available</td></tr>';
        return;
    }

    tbody.innerHTML = feedbackItems.map(item =>
        `<tr>
            <td><a href="${item.url}" target="_blank" rel="noopener">${item.url.length > 50 ? item.url.substring(0, 50) + '...' : item.url}</a></td>
            <td>${item.original_risk_score || 'N/A'} (${item.original_recommendation || 'unknown'})</td>
            <td>${item.user_correction || 'N/A'}</td>
            <td>${new Date(item.timestamp).toLocaleString()}</td>
        </tr>`
    ).join('');
}

function updateModelStatus(status) {
    // Update URL model info
    document.getElementById('url-model-version').textContent = status.url_model?.current_version || 'Unknown';
    document.getElementById('url-model-status').textContent = status.url_model?.loaded ? 'Loaded' : 'Not Loaded';

    const urlSelect = document.getElementById('url-model-versions');
    urlSelect.innerHTML = (status.url_model?.available_versions || []).map(version =>
        `<option value="${version}" ${version === status.url_model?.current_version ? 'selected' : ''}>${version}</option>`
    ).join('');

    // Update Email model info
    document.getElementById('email-model-version').textContent = status.email_model?.current_version || 'Unknown';
    document.getElementById('email-model-status').textContent = status.email_model?.loaded ? 'Loaded' : 'Not Loaded';

    const emailSelect = document.getElementById('email-model-versions');
    emailSelect.innerHTML = (status.email_model?.available_versions || []).map(version =>
        `<option value="${version}" ${version === status.email_model?.current_version ? 'selected' : ''}>${version}</option>`
    ).join('');

    // Update training history
    const trainingTbody = document.querySelector('#training-history-table tbody');
    const trainingItems = (status.training_history || []).slice(0, 5); // Show last 5

    if (trainingItems.length === 0) {
        trainingTbody.innerHTML = '<tr><td colspan="5">No training history available</td></tr>';
        return;
    }

    trainingTbody.innerHTML = trainingItems.map(item =>
        `<tr>
            <td>${item.version || 'N/A'}</td>
            <td>${new Date(item.timestamp).toLocaleString()}</td>
            <td>${item.url_model_accuracy ? item.url_model_accuracy.toFixed(4) : 'N/A'}</td>
            <td>${item.email_model_accuracy ? item.email_model_accuracy.toFixed(4) : 'N/A'}</td>
            <td>${item.total_samples || 'N/A'}</td>
        </tr>`
    ).join('');
}

async function switchModel(modelType) {
    const select = document.getElementById(`${modelType}-model-versions`);
    const version = select.value;

    if (!version) {
        alert('Please select a version');
        return;
    }

    try {
        const response = await fetch('/admin/api/models/switch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ model_type: modelType, version: version })
        });

        const result = await response.json();

        if (response.ok) {
            alert(result.message);
            refreshData(); // Reload dashboard data
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Error switching model:', error);
        alert('Failed to switch model version');
    }
}

async function retrainModels() {
    const btn = document.getElementById('retrain-btn');
    const status = document.getElementById('retrain-status');

    if (btn.disabled) return;

    if (!confirm('This will start model retraining in the background. It may take several minutes. Continue?')) {
        return;
    }

    try {
        btn.disabled = true;
        status.textContent = 'Starting retraining...';

        const response = await fetch('/admin/api/models/retrain', {
            method: 'POST'
        });

        const result = await response.json();

        if (response.ok) {
            status.textContent = 'Retraining started successfully';
            status.style.color = 'green';
        } else {
            status.textContent = 'Error: ' + result.error;
            status.style.color = 'red';
        }
    } catch (error) {
        console.error('Error starting retraining:', error);
        status.textContent = 'Failed to start retraining';
        status.style.color = 'red';
    } finally {
        btn.disabled = false;
        setTimeout(() => {
            status.textContent = '';
            refreshData(); // Reload to check for updates
        }, 5000);
    }
}

function refreshData() {
    loadDashboardData();
}

// Load data on page load
document.addEventListener('DOMContentLoaded', loadDashboardData);
</script>
{% endblock %}